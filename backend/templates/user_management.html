{% extends 'base.html' %}

{% block title %}User Management - EstradaBot{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-people-fill"></i> User Management</h2>
    <button class="btn btn-primary" onclick="showAddUserModal()">
        <i class="bi bi-person-plus"></i> Add User
    </button>
</div>

<!-- Users Table -->
<div class="card">
    <div class="card-body">
        <div id="loadingSpinner" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <table id="usersTable" class="table table-striped table-hover" style="width:100%; display:none;">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="usersTableBody"></tbody>
        </table>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-plus"></i> Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" id="newUsername" minlength="3" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="newPassword" minlength="6" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-control" id="newPasswordConfirm" minlength="6" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="newRole">
                        {% for role in valid_roles %}
                        <option value="{{ role }}">{{ role }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="addUserError" class="alert alert-danger" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addUser()">
                    <i class="bi bi-person-plus"></i> Create User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Role Modal -->
<div class="modal fade" id="editRoleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Change Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Changing role for: <strong id="editRoleUsername"></strong></p>
                <div class="mb-3">
                    <label class="form-label">New Role</label>
                    <select class="form-select" id="editRoleSelect">
                        {% for role in valid_roles %}
                        <option value="{{ role }}">{{ role }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="editRoleError" class="alert alert-danger" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateRole()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-key"></i> Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Resetting password for: <strong id="resetPwUsername"></strong></p>
                <div class="mb-3">
                    <label class="form-label">New Password</label>
                    <input type="password" class="form-control" id="resetPwNew" minlength="6" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-control" id="resetPwConfirm" minlength="6" required>
                </div>
                <div id="resetPwError" class="alert alert-danger" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="resetPassword()">Reset Password</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentEditUser = null;

$(document).ready(function() {
    loadUsers();
});

function loadUsers() {
    fetch('/api/users')
        .then(r => r.json())
        .then(data => {
            $('#loadingSpinner').hide();
            const tbody = $('#usersTableBody');
            tbody.empty();

            data.users.forEach(user => {
                const statusBadge = user.active
                    ? '<span class="badge bg-success">Active</span>'
                    : '<span class="badge bg-secondary">Disabled</span>';

                const roleBadge = `<span class="badge bg-info">${user.role}</span>`;

                const created = user.created_at ? new Date(user.created_at).toLocaleDateString() : '-';
                const updated = user.updated_at ? new Date(user.updated_at).toLocaleDateString() : '-';

                const toggleBtn = user.active
                    ? `<button class="btn btn-sm btn-outline-warning" onclick="toggleUser('${user.username}', false)" title="Disable"><i class="bi bi-person-slash"></i></button>`
                    : `<button class="btn btn-sm btn-outline-success" onclick="toggleUser('${user.username}', true)" title="Enable"><i class="bi bi-person-check"></i></button>`;

                tbody.append(`<tr class="${user.active ? '' : 'table-secondary'}">
                    <td><strong>${user.username}</strong></td>
                    <td>${roleBadge}</td>
                    <td>${statusBadge}</td>
                    <td>${created}</td>
                    <td>${updated}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-sm btn-outline-primary" onclick="showEditRoleModal('${user.username}', '${user.role}')" title="Change Role"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="showResetPasswordModal('${user.username}')" title="Reset Password"><i class="bi bi-key"></i></button>
                            ${toggleBtn}
                        </div>
                    </td>
                </tr>`);
            });

            $('#usersTable').show();
        })
        .catch(err => {
            $('#loadingSpinner').hide();
            console.error('Failed to load users:', err);
        });
}

function showAddUserModal() {
    $('#newUsername').val('');
    $('#newPassword').val('');
    $('#newPasswordConfirm').val('');
    $('#newRole').val('guest');
    $('#addUserError').hide();
    new bootstrap.Modal('#addUserModal').show();
}

function addUser() {
    const username = $('#newUsername').val().trim();
    const password = $('#newPassword').val();
    const confirm = $('#newPasswordConfirm').val();
    const role = $('#newRole').val();

    if (password !== confirm) {
        $('#addUserError').text('Passwords do not match.').show();
        return;
    }

    fetch('/api/users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username, password, role})
    })
    .then(r => r.json().then(d => ({ok: r.ok, data: d})))
    .then(({ok, data}) => {
        if (ok) {
            bootstrap.Modal.getInstance('#addUserModal').hide();
            loadUsers();
        } else {
            $('#addUserError').text(data.error).show();
        }
    });
}

function showEditRoleModal(username, currentRole) {
    currentEditUser = username;
    $('#editRoleUsername').text(username);
    $('#editRoleSelect').val(currentRole);
    $('#editRoleError').hide();
    new bootstrap.Modal('#editRoleModal').show();
}

function updateRole() {
    const role = $('#editRoleSelect').val();
    fetch(`/api/users/${currentEditUser}/role`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({role})
    })
    .then(r => r.json().then(d => ({ok: r.ok, data: d})))
    .then(({ok, data}) => {
        if (ok) {
            bootstrap.Modal.getInstance('#editRoleModal').hide();
            loadUsers();
        } else {
            $('#editRoleError').text(data.error).show();
        }
    });
}

function showResetPasswordModal(username) {
    currentEditUser = username;
    $('#resetPwUsername').text(username);
    $('#resetPwNew').val('');
    $('#resetPwConfirm').val('');
    $('#resetPwError').hide();
    new bootstrap.Modal('#resetPasswordModal').show();
}

function resetPassword() {
    const password = $('#resetPwNew').val();
    const confirm = $('#resetPwConfirm').val();

    if (password !== confirm) {
        $('#resetPwError').text('Passwords do not match.').show();
        return;
    }

    fetch(`/api/users/${currentEditUser}/reset-password`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({password})
    })
    .then(r => r.json().then(d => ({ok: r.ok, data: d})))
    .then(({ok, data}) => {
        if (ok) {
            bootstrap.Modal.getInstance('#resetPasswordModal').hide();
            alert('Password reset successfully.');
        } else {
            $('#resetPwError').text(data.error).show();
        }
    });
}

function toggleUser(username, enable) {
    const action = enable ? 'enable' : 'disable';
    if (!confirm(`Are you sure you want to ${action} user "${username}"?`)) return;

    fetch(`/api/users/${username}/${action}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json().then(d => ({ok: r.ok, data: d})))
    .then(({ok, data}) => {
        if (ok) {
            loadUsers();
        } else {
            alert(data.error);
        }
    });
}
</script>
{% endblock %}

{% extends 'base.html' %}

{% block title %}Dashboard - DD Scheduler Bot{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-speedometer2"></i> Dashboard</h2>
    <button class="btn btn-primary" onclick="generateSchedule()">
        <i class="bi bi-play-circle"></i> Generate Schedule
    </button>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="stat-value">{{ schedule.stats.total_orders or 0 }}</div>
                <div class="stat-label">Total Orders</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="stat-value status-on-time">{{ schedule.stats.on_time or 0 }}</div>
                <div class="stat-label">On Time</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="stat-value status-late">{{ schedule.stats.late or 0 }}</div>
                <div class="stat-label">Late</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="stat-value">{{ schedule.stats.avg_turnaround or '-' }}</div>
                <div class="stat-label">Avg Turnaround (days)</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Input Files Status -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-folder"></i> Input Files</span>
                <a href="/upload" class="btn btn-sm btn-outline-primary">Upload</a>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td><i class="bi bi-file-earmark-excel text-success"></i> Sales Order</td>
                            <td class="text-end">
                                {% if files.sales_order %}
                                    <span class="text-success"><i class="bi bi-check-circle"></i> {{ files.sales_order.name[:30] }}...</span>
                                {% else %}
                                    <span class="text-muted"><i class="bi bi-x-circle"></i> Not uploaded</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><i class="bi bi-file-earmark-excel text-success"></i> Shop Dispatch</td>
                            <td class="text-end">
                                {% if files.shop_dispatch %}
                                    <span class="text-success"><i class="bi bi-check-circle"></i> {{ files.shop_dispatch.name[:30] }}...</span>
                                {% else %}
                                    <span class="text-muted"><i class="bi bi-dash-circle"></i> Optional</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><i class="bi bi-file-earmark-excel text-warning"></i> Hot List</td>
                            <td class="text-end">
                                {% if files.hot_list %}
                                    <span class="text-warning"><i class="bi bi-exclamation-circle"></i> {{ files.hot_list.name[:30] }}...</span>
                                {% else %}
                                    <span class="text-muted"><i class="bi bi-dash-circle"></i> Optional</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if current_user.role == 'admin' %}
                        <tr>
                            <td><i class="bi bi-file-earmark-excel text-info"></i> Core Mapping <span class="badge bg-info">Admin</span></td>
                            <td class="text-end">
                                {% if files.core_mapping %}
                                    <span class="text-success"><i class="bi bi-check-circle"></i> {{ files.core_mapping.name[:30] }}...</span>
                                {% else %}
                                    <span class="text-danger"><i class="bi bi-x-circle"></i> Required</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Recent Reports -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-file-earmark-excel"></i> Recent Reports</span>
                <a href="/reports" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% if reports %}
                    <table class="table table-sm table-hover">
                        <tbody>
                            {% for report in reports %}
                            <tr>
                                <td>
                                    <i class="bi bi-file-earmark-excel text-success"></i>
                                    {{ report.type }}
                                </td>
                                <td class="text-muted small">
                                    {{ report.modified.strftime('%m/%d %H:%M') }}
                                </td>
                                <td class="text-end">
                                    <a href="/api/download/{{ report.filename }}" class="btn btn-sm btn-outline-success">
                                        <i class="bi bi-download"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted text-center py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i><br>
                        No reports generated yet.<br>
                        <small>Click "Generate Schedule" to create reports.</small>
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Schedule Preview -->
{% if schedule.orders %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-table"></i> Schedule Preview (Top 10)</span>
        <div>
            {% if schedule.generated_at %}
                <small class="text-muted me-3">Generated: {{ schedule.generated_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
            {% endif %}
            <a href="/schedule" class="btn btn-sm btn-outline-primary">View Full Schedule</a>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>WO#</th>
                        <th>Part Number</th>
                        <th>Customer</th>
                        <th>Priority</th>
                        <th>BLAST Date</th>
                        <th>Completion</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in schedule.orders[:10] %}
                    <tr>
                        <td><strong>{{ order.wo_number }}</strong></td>
                        <td>{{ order.part_number }}</td>
                        <td>{{ order.customer[:20] }}{% if order.customer|length > 20 %}...{% endif %}</td>
                        <td>
                            {% if order.priority == 'Hot-ASAP' %}
                                <span class="badge priority-hot-asap">ASAP</span>
                            {% elif order.priority == 'Hot-Dated' %}
                                <span class="badge priority-hot-dated">DATED</span>
                            {% elif order.priority == 'Rework' %}
                                <span class="badge priority-rework">REWORK</span>
                            {% else %}
                                <span class="badge priority-normal">NORMAL</span>
                            {% endif %}
                        </td>
                        <td>{{ order.blast_date.strftime('%m/%d %H:%M') if order.blast_date else '-' }}</td>
                        <td>{{ order.completion_date.strftime('%m/%d %H:%M') if order.completion_date else '-' }}</td>
                        <td>
                            {% if order.on_time_status == 'On Time' %}
                                <span class="badge bg-success">On Time</span>
                            {% elif order.on_time_status == 'Late' %}
                                <span class="badge bg-danger">Late</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">At Risk</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-calendar-x" style="font-size: 4rem; color: #dee2e6;"></i>
        <h4 class="mt-3 text-muted">No Schedule Generated</h4>
        <p class="text-muted">Upload your input files and click "Generate Schedule" to get started.</p>
        <div class="mt-3">
            <a href="/upload" class="btn btn-outline-primary me-2">
                <i class="bi bi-cloud-upload"></i> Upload Files
            </a>
            <button class="btn btn-primary" onclick="generateSchedule()">
                <i class="bi bi-play-circle"></i> Generate Schedule
            </button>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

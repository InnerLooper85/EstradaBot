{% extends 'base.html' %}

{% block title %}Update Log - EstradaBot{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-journal-text"></i> Update Log</h2>
    <span class="badge bg-info fs-6">Current Version: MVP 1.8</span>
</div>

<!-- Feedback Form -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-chat-dots"></i> Submit Feedback
    </div>
    <div class="card-body">
        <form id="feedbackForm" enctype="multipart/form-data">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="feedbackCategory" class="form-label">Category</label>
                    <select class="form-select" id="feedbackCategory" required onchange="onCategoryChange()">
                        <option value="">Select...</option>
                        <option value="Bug Report">Bug Report</option>
                        <option value="Feature Request">Feature Request</option>
                        <option value="Data Issue">Data Issue</option>
                        <option value="UI/UX Improvement">UI/UX Improvement</option>
                        <option value="Example File">Example File</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="feedbackPriority" class="form-label">Priority</label>
                    <select class="form-select" id="feedbackPriority">
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="feedbackPage" class="form-label">Related Page (optional)</label>
                    <select class="form-select" id="feedbackPage">
                        <option value="">None</option>
                        <option value="Dashboard">Dashboard</option>
                        <option value="Upload">Upload Files</option>
                        <option value="Schedule">Schedule</option>
                        <option value="Reports">Reports</option>
                        <option value="Simulation">Simulation</option>
                        <option value="Planner">Planner Workflow</option>
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label for="feedbackMessage" class="form-label">Description</label>
                <textarea class="form-control" id="feedbackMessage" rows="3" required
                    placeholder="Describe the issue, suggestion, or feedback..."></textarea>
            </div>
            <div class="mb-3">
                <label for="feedbackFile" class="form-label">
                    <i class="bi bi-paperclip"></i> Attach File
                    <small class="text-muted">(screenshots, Excel files — max 25 MB)</small>
                </label>
                <input type="file" class="form-control" id="feedbackFile"
                       accept=".png,.jpg,.jpeg,.gif,.bmp,.xlsx,.xls,.csv">
                <div id="exampleFileHint" class="form-text text-info" style="display: none;">
                    <i class="bi bi-info-circle"></i>
                    <strong>Example File:</strong> Upload an Excel file for debugging or feature development. It will be stored in the development files area.
                </div>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-send"></i> Submit Feedback
            </button>
        </form>
        <div id="feedbackSuccess" class="alert alert-success mt-3" style="display: none;">
            <i class="bi bi-check-circle"></i> Thank you! Your feedback has been submitted.
        </div>
    </div>
</div>

<!-- Recent Feedback (admin only) -->
{% if current_user.role == 'admin' %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-inbox"></i> Submitted Feedback</span>
        <span class="badge bg-secondary" id="feedbackCount">0</span>
    </div>
    <div class="card-body">
        <div id="feedbackList">
            <p class="text-muted text-center py-3">Loading feedback...</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Update Log Entries -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-clock-history"></i> Version History
    </div>
    <div class="card-body">
        <!-- MVP 1.8 -->
        <div class="mb-4">
            <h5>
                <span class="badge bg-info">MVP 1.8</span>
                <small class="text-muted ms-2">February 2026 - Quick Wins &amp; Reporting</small>
            </h5>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Role Name Normalization:</strong> Standardized <code>customer_service</code> role name across the codebase, eliminating the inconsistency between <code>customer_service</code> and <code>customerservice</code> variants. Tech debt cleanup ahead of RBAC work in MVP 1.10.
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Days Idle Column:</strong> Added "Days Idle" column to the Master Schedule export. Sourced from Shop Dispatch "Elapsed Days" field with automatic 9999 &rarr; 0 conversion. Helps identify orders sitting idle in work-in-process.
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Resource Utilization Report:</strong> New Excel export with per-station and per-injection-machine utilization metrics. Includes processing hours, idle hours, setup/changeover hours, and utilization percentage. Available on the Reports page.
                </li>
            </ul>
        </div>

        <!-- MVP 1.7 -->
        <div class="mb-4">
            <h5>
                <span class="badge bg-info">MVP 1.7</span>
                <small class="text-muted ms-2">February 2026 - Alerts, Notifications &amp; Quality of Life</small>
            </h5>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Alert Reports:</strong> Late orders, promise date risk, core shortage, and machine utilization alerts — auto-generated on schedule publish with on-demand refresh
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Alert Dashboard Cards:</strong> At-a-glance alert summary on the main dashboard with link to dedicated Alerts page
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Notification Bell:</strong> In-app notification system with unread badge, dropdown panel, and dedicated notifications page. Auto-marks as read after 7 days.
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Feedback Status Tracking:</strong> Admin can set feedback status (New, In-Work, Fixed, Resolved w/o Action) directly from the feedback table
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Expanded Redline Requests:</strong> Cutback Length Change, Hip &amp; Cap Injection, and Full Restrict Injection request types added
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Special Instructions Column:</strong> Added to Blast, Core Oven, and Master schedule exports — populated from approved redline requests
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>DCP Report Integration:</strong> Upload DCP reports to populate Supermarket Location column on the Blast schedule
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Order Holds:</strong> Place orders on hold to exclude from scheduling; persists across uploads and schedule generations
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Simulation Defaults to Published:</strong> Visual simulation now loads from the last published schedule without requiring a fresh generate
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Mode B Reconciliation:</strong> Data mismatch detection when placeholders match uploaded WOs; 28-day auto-expiration for unmatched placeholders
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Bug Fixes:</strong> Role case sensitivity (Planner vs planner), file name detection (OSO_*, SDR_* patterns)
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Automated Tests:</strong> 51 pytest tests covering DES engine, API endpoints, and page access
                </li>
            </ul>
        </div>

        <!-- MVP 1.6 -->
        <div class="mb-4">
            <h5>
                <span class="badge bg-info">MVP 1.6</span>
                <small class="text-muted ms-2">February 2026 - Mfg Eng Review Page</small>
            </h5>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Mfg Eng Review Page:</strong> Added new Manufacturing Engineering Review title page with sidebar navigation link, accessible to all logged-in users
                </li>
            </ul>
        </div>

        <!-- MVP 1.5 -->
        <div class="mb-4">
            <h5>
                <span class="badge bg-info">MVP 1.5</span>
                <small class="text-muted ms-2">February 2026 - Bug Fix Release</small>
            </h5>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Fix Duplicate Error Reports:</strong> Resolved issue where missing WO# and part number errors were reported twice — once during file parsing and again during validation
                </li>
            </ul>
        </div>

        <!-- MVP 1.4 -->
        <div class="mb-4">
            <h5>
                <span class="badge bg-info">MVP 1.4</span>
                <small class="text-muted ms-2">February 2026 - Special Requests System</small>
            </h5>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Dedicated Special Requests Page:</strong> New page accessible to all roles for submitting, reviewing, and managing schedule change requests
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Two-Mode Submission:</strong> Mode A searches existing orders with autocomplete; Mode B creates placeholder requests for WOs not yet in the system
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Hot List &amp; Redline Requests:</strong> Submit priority bumps (ASAP/dated) or rubber substitution changes (XE, HR, XD, XR)
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Impact Preview:</strong> See scheduling impact before submitting a request — shows delayed orders and newly-late orders
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Approval Queue:</strong> Status-filtered queue with approve/reject actions for planners; rejection reasons tracked and visible
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>WO Reconciliation:</strong> Mode B placeholders automatically match when matching data files are uploaded
                </li>
            </ul>
        </div>

        <!-- MVP 1.3 -->
        <div class="mb-4">
            <h5>
                <span class="badge bg-info">MVP 1.3</span>
                <small class="text-muted ms-2">February 2026 - Planner Workflow &amp; Feedback Release</small>
            </h5>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Planner Workflow Dashboard:</strong> New multi-step workflow for production planners — load data, simulate scenarios, review requests, publish schedules
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>3-Scenario Comparison:</strong> Side-by-side comparison of 4-day/10h, 4-day/12h, and 5-day/12h shift configurations
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Configurable Shift Hours:</strong> DES scheduler now supports 10-hour and 12-hour shift configurations
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Special Request Queue:</strong> Customer service can submit hot list requests; planners review with impact simulation
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Feedback File Uploads:</strong> Attach screenshots and Excel files to feedback submissions for debugging and analysis
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Local Dev Storage:</strong> Local filesystem fallback for development without GCS credentials
                </li>
            </ul>
        </div>

        <!-- MVP 1.2 -->
        <div class="mb-4">
            <h5>
                <span class="badge bg-info">MVP 1.2</span>
                <small class="text-muted ms-2">February 2026 - Documentation &amp; Collaboration Release</small>
            </h5>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Team Collaboration Setup:</strong> Project instructions and onboarding documentation for multi-developer workflow
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>MVP 2.0 Planning:</strong> Comprehensive planning document with feature roadmap and clarifying questions
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Session Startup Protocol:</strong> Mandatory branch and commit verification checks before each development session
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Versioning Protocol:</strong> Formal version bump process for production releases (badge, update log, docs)
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Data Fields Reference:</strong> Complete input field mapping document for SAP integration planning
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Implementation Plan Finalized:</strong> All Phase 8 (MVP 1.1) items verified complete with updated status tracking
                </li>
            </ul>
        </div>

        <!-- MVP 1.1 -->
        <div class="mb-4">
            <h5>
                <span class="badge bg-info">MVP 1.1</span>
                <small class="text-muted ms-2">February 2026 - User Feedback Release</small>
            </h5>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>BLAST Time Fix:</strong> First BLAST now starts at 5:30 AM (30-minute handover)
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Pegging Report Removed:</strong> Turnaround calculation simplified (uses WO Creation Date for all orders)
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Data Scrubbing:</strong> Sensitive columns (Unit Price, Customer Address) automatically stripped on upload
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Serial Number Column:</strong> Added to Schedule view and all exported reports
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Column Filtering:</strong> Per-column search and dropdown filters on the Schedule page
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Version Header:</strong> Version badge shown in navbar with Update Log page
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>User Feedback Form:</strong> Submit bug reports, feature requests, and suggestions
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Rubber Type Alternation:</strong> XE-HR-XE-HR BLAST sequence optimization within priority tiers
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Published Schedule:</strong> Planner/Admin can publish schedules; regular users see the published version
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>4/5-Day Toggle:</strong> Both 4-day (Mon-Thu) and 5-day (Mon-Fri) schedules pre-generated with toggle switch
                </li>
            </ul>
        </div>

        <!-- MVP 1.0 -->
        <div class="mb-4">
            <h5>
                <span class="badge bg-secondary">MVP 1.0</span>
                <small class="text-muted ms-2">January 2026 - Initial Release</small>
            </h5>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>DES Scheduling Engine:</strong> Pipeline-based Discrete Event Simulation
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>5-Tier Priority System:</strong> Hot-ASAP, Hot-Dated, Rework, Normal, CAVO
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Core Management:</strong> Automatic core assignment with lifecycle tracking
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Hot List Prioritization:</strong> Impact analysis showing delayed orders
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Excel Reports:</strong> Master Schedule, BLAST Schedule, Core Oven, Pending Core, Impact Analysis
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>Visual Simulation:</strong> Factory floor animation with real-time order tracking
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>GCS Cloud Storage:</strong> Persistent file storage and schedule state
                </li>
                <li class="list-group-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong>User Authentication:</strong> Login system with admin and user roles
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Show hint when "Example File" category is selected
    function onCategoryChange() {
        const category = document.getElementById('feedbackCategory').value;
        const hint = document.getElementById('exampleFileHint');
        hint.style.display = category === 'Example File' ? 'block' : 'none';
    }

    // Feedback form submission with file upload support
    document.getElementById('feedbackForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const fileInput = document.getElementById('feedbackFile');
        const hasFile = fileInput.files && fileInput.files.length > 0;

        // Use FormData for multipart upload when file is present
        const formData = new FormData();
        formData.append('category', document.getElementById('feedbackCategory').value);
        formData.append('priority', document.getElementById('feedbackPriority').value);
        formData.append('page', document.getElementById('feedbackPage').value);
        formData.append('message', document.getElementById('feedbackMessage').value);

        if (hasFile) {
            formData.append('file', fileInput.files[0]);
        }

        fetch('/api/feedback', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('feedbackSuccess').style.display = 'block';
                document.getElementById('feedbackForm').reset();
                document.getElementById('exampleFileHint').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('feedbackSuccess').style.display = 'none';
                }, 5000);
                // Refresh feedback list if admin
                if (document.getElementById('feedbackList')) {
                    loadFeedback();
                }
            } else {
                alert('Error submitting feedback: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    });

    // Load feedback list (admin only)
    {% if current_user.role == 'admin' %}
    function loadFeedback() {
        fetch('/api/feedback')
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('feedbackList');
                const count = document.getElementById('feedbackCount');

                if (!data.feedback || data.feedback.length === 0) {
                    list.innerHTML = '<p class="text-muted text-center py-3">No feedback submitted yet.</p>';
                    count.textContent = '0';
                    return;
                }

                count.textContent = data.feedback.length;
                let html = '<div class="table-responsive"><table class="table table-sm table-hover"><thead><tr>' +
                    '<th>Date</th><th>User</th><th>Category</th><th>Priority</th><th>Status</th><th>Page</th><th>Message</th><th>File</th>' +
                    '</tr></thead><tbody>';

                data.feedback.forEach((fb, idx) => {
                    const date = new Date(fb.submitted_at).toLocaleDateString('en-US', {
                        month: '2-digit', day: '2-digit', year: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    });
                    const priorityClass = fb.priority === 'High' ? 'text-danger' :
                                         fb.priority === 'Medium' ? 'text-warning' : 'text-muted';
                    const categoryClass = fb.category === 'Example File' ? 'bg-info' : 'bg-secondary';

                    const status = fb.status || 'New';
                    const statusColors = {
                        'New': 'bg-primary',
                        'In-Work': 'bg-warning text-dark',
                        'Fixed': 'bg-success',
                        'Resolved w/o Action': 'bg-secondary'
                    };
                    const statusBadge = statusColors[status] || 'bg-secondary';

                    const statusCell = `<div class="dropdown">
                        <button class="btn btn-sm dropdown-toggle p-0 border-0" type="button"
                                data-bs-toggle="dropdown" style="background: none;">
                            <span class="badge ${statusBadge}">${status}</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-sm">
                            <li><a class="dropdown-item ${status === 'New' ? 'active' : ''}" href="#"
                                   onclick="updateFeedbackStatus(${idx}, 'New'); return false;">New</a></li>
                            <li><a class="dropdown-item ${status === 'In-Work' ? 'active' : ''}" href="#"
                                   onclick="updateFeedbackStatus(${idx}, 'In-Work'); return false;">In-Work</a></li>
                            <li><a class="dropdown-item ${status === 'Fixed' ? 'active' : ''}" href="#"
                                   onclick="updateFeedbackStatus(${idx}, 'Fixed'); return false;">Fixed</a></li>
                            <li><a class="dropdown-item ${status === 'Resolved w/o Action' ? 'active' : ''}" href="#"
                                   onclick="updateFeedbackStatus(${idx}, 'Resolved w/o Action'); return false;">Resolved w/o Action</a></li>
                        </ul>
                    </div>`;

                    let fileCell = '-';
                    if (fb.attachment) {
                        const a = fb.attachment;
                        const isImage = ['png','jpg','jpeg','gif','bmp'].includes(a.type);
                        const icon = isImage ? 'bi-image' : 'bi-file-earmark-excel';
                        const sizeKb = Math.round((a.size || 0) / 1024);
                        fileCell = `<a href="/api/feedback/download/${a.stored_as}?folder=${encodeURIComponent(a.folder)}"
                                      class="text-decoration-none" title="${a.filename}">
                                      <i class="bi ${icon}"></i> ${a.filename.substring(0, 20)}
                                      <small class="text-muted">(${sizeKb} KB)</small>
                                   </a>`;
                    }

                    html += `<tr>
                        <td class="small">${date}</td>
                        <td>${fb.username || '-'}</td>
                        <td><span class="badge ${categoryClass}">${fb.category}</span></td>
                        <td class="${priorityClass}">${fb.priority}</td>
                        <td>${statusCell}</td>
                        <td>${fb.page || '-'}</td>
                        <td>${fb.message.substring(0, 100)}${fb.message.length > 100 ? '...' : ''}</td>
                        <td>${fileCell}</td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
                list.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading feedback:', error);
                document.getElementById('feedbackList').innerHTML =
                    '<p class="text-danger text-center py-3">Failed to load feedback.</p>';
            });
    }

    function updateFeedbackStatus(index, newStatus) {
        fetch(`/api/feedback/${index}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadFeedback();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => alert('Error: ' + error.message));
    }

    // Load on page load
    loadFeedback();
    {% endif %}
</script>
{% endblock %}

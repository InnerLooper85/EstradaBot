{% extends 'base.html' %}

{% block title %}Schedule - EstradaBot{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-table"></i> Schedule</h2>
    <div class="d-flex align-items-center">
        <span id="publishedBy" class="text-muted me-2"></span>
        <span id="generatedAt" class="text-muted me-3"></span>
        <!-- Schedule Mode Toggle -->
        <div id="modeToggle" class="btn-group me-2" role="group" style="display: none;">
            <button type="button" class="btn btn-sm btn-outline-secondary active" id="btn4day" onclick="switchMode('4day')">4-Day</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn5day" onclick="switchMode('5day')">5-Day</button>
        </div>
        <button class="btn btn-outline-primary me-2" onclick="refreshSchedule()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        {% if can_generate %}
        <button class="btn btn-primary" onclick="generateSchedule()">
            <i class="bi bi-play-circle"></i> Generate New
        </button>
        {% endif %}
    </div>
</div>

<!-- Reorder Controls (admin/planner only) -->
{% if can_generate %}
<div id="reorderControls" class="mb-3" style="display:none;">
    <div class="d-flex align-items-center">
        <div class="form-check form-switch me-3">
            <input class="form-check-input" type="checkbox" id="reorderToggle" onchange="toggleReorderMode()">
            <label class="form-check-label" for="reorderToggle">Reorder Mode</label>
        </div>
        <div id="reorderActions" style="display:none;">
            <button class="btn btn-sm btn-success me-1" onclick="saveReorder()">
                <i class="bi bi-check-lg"></i> Save Order
            </button>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="resetReorder()">
                <i class="bi bi-arrow-counterclockwise"></i> Reset
            </button>
            <span id="reorderStatus" class="text-muted small ms-2"></span>
        </div>
        <div id="reorderBadge" style="display:none;">
            <span class="badge bg-info"><i class="bi bi-arrows-move"></i> Custom Order Active</span>
            <button class="btn btn-sm btn-outline-danger ms-1" onclick="clearReorder()">
                <i class="bi bi-x"></i> Clear Custom Order
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Stats Summary -->
<div id="statsSection" class="row mb-4" style="display: none;">
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <div class="h4 mb-0" id="statTotal">0</div>
                <small class="text-muted">Total Orders</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <div class="h4 mb-0 text-success" id="statOnTime">0</div>
                <small class="text-muted">On Time</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <div class="h4 mb-0 text-danger" id="statLate">0</div>
                <small class="text-muted">Late</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <div class="h4 mb-0 text-warning" id="statAtRisk">0</div>
                <small class="text-muted">At Risk</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <div class="h4 mb-0" id="statTurnaround">-</div>
                <small class="text-muted">Avg Turnaround</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <div class="h4 mb-0 text-danger" id="statHotList">0</div>
                <small class="text-muted">Hot List</small>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Table -->
<div class="card">
    <div class="card-body">
        <div id="loadingSpinner" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading schedule...</p>
        </div>

        <div id="noSchedule" class="text-center py-5" style="display: none;">
            <i class="bi bi-calendar-x" style="font-size: 4rem; color: #dee2e6;"></i>
            <h4 class="mt-3 text-muted">No Schedule Generated</h4>
            <p class="text-muted">Upload your input files and generate a schedule to view it here.</p>
            {% if can_generate %}
            <button class="btn btn-primary" onclick="generateSchedule()">
                <i class="bi bi-play-circle"></i> Generate Schedule
            </button>
            {% endif %}
        </div>

        <div id="scheduleTableContainer" style="display: none;">
            <table id="scheduleTable" class="table table-striped table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th class="reorder-col" style="display:none;"></th>
                        <th>Seq</th>
                        <th>WO#</th>
                        <th>Serial #</th>
                        <th>Part Number</th>
                        <th>Description</th>
                        <th>Customer</th>
                        <th>Core</th>
                        <th>Supermarket Loc</th>
                        <th>Special Instructions</th>
                        <th>Rubber</th>
                        <th>Priority</th>
                        <th>BLAST Date</th>
                        <th>Completion</th>
                        <th>Promise Date</th>
                        <th>Turnaround</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="scheduleTableBody">
                </tbody>
                <tfoot>
                    <tr>
                        <th class="reorder-col" style="display:none;"></th>
                        <th>Seq</th>
                        <th>WO#</th>
                        <th>Serial #</th>
                        <th>Part Number</th>
                        <th>Description</th>
                        <th>Customer</th>
                        <th>Core</th>
                        <th>Supermarket Loc</th>
                        <th>Special Instructions</th>
                        <th>Rubber</th>
                        <th>Priority</th>
                        <th>BLAST Date</th>
                        <th>Completion</th>
                        <th>Promise Date</th>
                        <th>Turnaround</th>
                        <th>Status</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    #scheduleTable tfoot .column-filter {
        font-size: 0.75rem;
        padding: 0.2rem 0.4rem;
    }
    #scheduleTable tfoot th {
        padding: 4px;
    }
    .drag-handle {
        cursor: grab;
        color: #999;
        font-size: 1.1rem;
    }
    .drag-handle:hover {
        color: #333;
    }
    .sortable-ghost {
        opacity: 0.4;
        background: #d4edff !important;
    }
    .sortable-chosen {
        background: #e8f4ff !important;
    }
    .reorder-active #scheduleTable tbody tr {
        cursor: grab;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- DataTables Buttons extension -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<!-- SortableJS for drag-and-drop reorder -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.3/Sortable.min.js"></script>

<script>
    let dataTable = null;
    let currentMode = '4day';
    let reorderMode = false;
    let sortableInstance = null;
    let originalOrder = [];  // WO numbers in original order
    let currentOrders = [];  // Current orders data from API
    const canReorder = {{ 'true' if can_generate else 'false' }};

    $(document).ready(function() {
        loadSchedule();
    });

    function switchMode(mode) {
        currentMode = mode;
        $('#btn4day').toggleClass('active', mode === '4day');
        $('#btn5day').toggleClass('active', mode === '5day');
        if (reorderMode) toggleReorderMode();  // exit reorder mode on mode switch
        loadSchedule();
    }

    function loadSchedule() {
        $('#loadingSpinner').show();
        $('#noSchedule').hide();
        $('#scheduleTableContainer').hide();
        $('#statsSection').hide();

        fetch('/api/schedule?mode=' + currentMode)
            .then(response => response.json())
            .then(data => {
                $('#loadingSpinner').hide();

                if (!data.orders || data.orders.length === 0) {
                    $('#noSchedule').show();
                    return;
                }

                currentOrders = data.orders;

                // Show mode toggle if dual modes are available
                if (data.has_modes) {
                    $('#modeToggle').show();
                }

                // Show reorder controls for admin/planner
                if (canReorder) {
                    $('#reorderControls').show();
                    if (data.has_reorder) {
                        $('#reorderBadge').show();
                    } else {
                        $('#reorderBadge').hide();
                    }
                }

                // Update stats
                if (data.stats) {
                    $('#statsSection').show();
                    $('#statTotal').text(data.stats.total_orders || 0);
                    $('#statOnTime').text(data.stats.on_time || 0);
                    $('#statLate').text(data.stats.late || 0);
                    $('#statAtRisk').text(data.stats.at_risk || 0);
                    $('#statTurnaround').text(data.stats.avg_turnaround || '-');
                    $('#statHotList').text(data.stats.hot_list_count || 0);
                }

                // Update generated at timestamp and publisher
                if (data.generated_at) {
                    const date = new Date(data.generated_at);
                    $('#generatedAt').text('Generated: ' + date.toLocaleString());
                }
                if (data.published_by) {
                    $('#publishedBy').html('<i class="bi bi-person-check"></i> Published by: <strong>' + data.published_by + '</strong>');
                }

                // Build table body
                const tbody = $('#scheduleTableBody');
                tbody.empty();
                originalOrder = [];

                data.orders.forEach((order, idx) => {
                    const row = buildOrderRow(order, idx + 1);
                    tbody.append(row);
                    originalOrder.push(order.wo_number);
                });

                $('#scheduleTableContainer').show();

                // Initialize or reinitialize DataTable
                if (dataTable) {
                    dataTable.destroy();
                }

                // Column indices shifted by 2 (drag handle col + seq col)
                // Drag handle: 0, Seq: 1, WO: 2, Serial: 3, Part: 4, Desc: 5, Customer: 6,
                // Core: 7, SM Loc: 8, Special: 9, Rubber: 10, Priority: 11, BLAST: 12,
                // Completion: 13, Promise: 14, Turnaround: 15, Status: 16
                const dropdownColumns = {
                    10: ['XE', 'HR', 'XD', 'XR'],
                    11: ['ASAP', 'DATED', 'REWORK', 'NORMAL', 'CAVO'],
                    16: ['On Time', 'Late', 'At Risk']
                };

                // Build filter inputs in tfoot before DataTable init
                $('#scheduleTable tfoot th').each(function(i) {
                    if (i === 0) {
                        // Drag handle column - no filter
                        $(this).html('');
                    } else if (i === 5) {
                        // Hidden description column - no filter
                        $(this).html('');
                    } else if (dropdownColumns[i]) {
                        let options = '<option value="">All</option>';
                        dropdownColumns[i].forEach(val => {
                            options += `<option value="${val}">${val}</option>`;
                        });
                        $(this).html(`<select class="form-select form-select-sm column-filter">${options}</select>`);
                    } else {
                        $(this).html('<input type="text" class="form-control form-control-sm column-filter" placeholder="Filter...">');
                    }
                });

                dataTable = $('#scheduleTable').DataTable({
                    pageLength: -1,  // Show all for reorder to work
                    lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                    order: [],  // Preserve server order (reorder-aware)
                    dom: 'Blfrtip',
                    buttons: [
                        {
                            extend: 'excel',
                            text: '<i class="bi bi-file-earmark-excel"></i> Export Excel',
                            className: 'btn btn-success btn-sm',
                            exportOptions: { columns: ':visible:not(.reorder-col)' }
                        },
                        {
                            extend: 'print',
                            text: '<i class="bi bi-printer"></i> Print',
                            className: 'btn btn-secondary btn-sm',
                            exportOptions: { columns: ':visible:not(.reorder-col)' }
                        }
                    ],
                    columnDefs: [
                        { targets: [0], visible: false, orderable: false, className: 'reorder-col' },  // drag handle - hidden until reorder mode
                        { targets: [5], visible: false }  // Hide description by default
                    ],
                    autoWidth: false
                });

                // Wire up column filters
                dataTable.columns().every(function() {
                    const column = this;
                    const footer = $(column.footer());
                    const input = footer.find('.column-filter');

                    if (input.is('input')) {
                        input.on('keyup change', function() {
                            if (column.search() !== this.value) {
                                column.search(this.value).draw();
                            }
                        });
                    } else if (input.is('select')) {
                        input.on('change', function() {
                            const val = $.fn.dataTable.util.escapeRegex(this.value);
                            column.search(val ? val : '', false, false).draw();
                        });
                    }
                });
            })
            .catch(error => {
                console.error('Error loading schedule:', error);
                $('#loadingSpinner').hide();
                $('#noSchedule').show();
            });
    }

    function buildOrderRow(order, seq) {
        const blastDate = order.blast_date ? formatDate(order.blast_date) : '-';
        const completionDate = order.completion_date ? formatDate(order.completion_date) : '-';
        const promiseDate = order.promise_date ? formatDateShort(order.promise_date) : '-';

        let priorityBadge = '';
        switch(order.priority) {
            case 'Hot-ASAP':
                priorityBadge = '<span class="badge priority-hot-asap">ASAP</span>';
                break;
            case 'Hot-Dated':
                priorityBadge = '<span class="badge priority-hot-dated">DATED</span>';
                break;
            case 'Rework':
                priorityBadge = '<span class="badge priority-rework">REWORK</span>';
                break;
            case 'CAVO':
                priorityBadge = '<span class="badge bg-info">CAVO</span>';
                break;
            default:
                priorityBadge = '<span class="badge priority-normal">NORMAL</span>';
        }

        let statusBadge = '';
        switch(order.on_time_status) {
            case 'Late':
                statusBadge = '<span class="badge bg-danger">Late</span>';
                break;
            case 'At Risk':
                statusBadge = '<span class="badge bg-warning text-dark">At Risk</span>';
                break;
            default:
                statusBadge = '<span class="badge bg-success">On Time</span>';
        }

        const desc = order.description || '';
        const customer = order.customer || '';
        const specialInstr = order.special_instructions || '';
        const smLoc = order.supermarket_location || '';

        return `<tr data-wo="${order.wo_number}">
            <td class="reorder-col" style="display:none;"><i class="bi bi-grip-vertical drag-handle"></i></td>
            <td>${seq}</td>
            <td><strong>${order.wo_number}</strong></td>
            <td>${order.serial_number || '-'}</td>
            <td>${order.part_number}</td>
            <td>${desc.substring(0, 40)}${desc.length > 40 ? '...' : ''}</td>
            <td>${customer.substring(0, 25)}${customer.length > 25 ? '...' : ''}</td>
            <td>${order.core || '-'}</td>
            <td>${smLoc ? '<span class="badge bg-light text-dark">' + smLoc + '</span>' : '-'}</td>
            <td>${specialInstr ? '<small>' + specialInstr.substring(0, 40) + (specialInstr.length > 40 ? '...' : '') + '</small>' : '-'}</td>
            <td>${order.rubber_type || '-'}</td>
            <td>${priorityBadge}</td>
            <td data-order="${order.blast_date || ''}">${blastDate}</td>
            <td data-order="${order.completion_date || ''}">${completionDate}</td>
            <td data-order="${order.promise_date || ''}">${promiseDate}</td>
            <td>${order.turnaround_days || '-'}</td>
            <td>${statusBadge}</td>
        </tr>`;
    }

    function toggleReorderMode() {
        reorderMode = document.getElementById('reorderToggle').checked;

        if (reorderMode) {
            // Enter reorder mode: show drag handles, disable DataTable sorting, show all rows
            if (dataTable) {
                // Show all rows for reorder
                dataTable.page.len(-1).draw();
                // Disable sorting
                dataTable.order([]).draw();
            }

            // Show drag handle column
            $('.reorder-col').show();
            if (dataTable) dataTable.column(0).visible(true);

            // Show reorder action buttons
            $('#reorderActions').show();
            document.body.classList.add('reorder-active');
            $('#reorderStatus').text('Drag rows to reorder');

            // Initialize SortableJS on tbody
            const tbody = document.getElementById('scheduleTableBody');
            sortableInstance = Sortable.create(tbody, {
                handle: '.drag-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onEnd: function() {
                    updateSequenceNumbers();
                    $('#reorderStatus').text('Unsaved changes');
                }
            });
        } else {
            // Exit reorder mode
            if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
            }

            // Hide drag handle column
            $('.reorder-col').hide();
            if (dataTable) dataTable.column(0).visible(false);

            $('#reorderActions').hide();
            document.body.classList.remove('reorder-active');
        }
    }

    function updateSequenceNumbers() {
        // Update the Seq column after a drag
        const rows = document.querySelectorAll('#scheduleTableBody tr');
        rows.forEach((row, idx) => {
            row.cells[1].textContent = idx + 1;
        });
    }

    function saveReorder() {
        // Collect current WO order from DOM
        const rows = document.querySelectorAll('#scheduleTableBody tr');
        const sequence = [];
        rows.forEach(row => {
            const wo = row.getAttribute('data-wo');
            if (wo) sequence.push(wo);
        });

        fetch('/api/schedule/reorder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({mode: currentMode, sequence: sequence})
        })
        .then(r => r.json().then(d => ({ok: r.ok, data: d})))
        .then(({ok, data}) => {
            if (ok) {
                $('#reorderStatus').text('Saved!');
                $('#reorderBadge').show();
                setTimeout(() => $('#reorderStatus').text(''), 2000);
            } else {
                alert('Failed to save: ' + (data.error || 'Unknown error'));
            }
        });
    }

    function resetReorder() {
        if (!confirm('Reset to original order? Unsaved changes will be lost.')) return;
        // Exit reorder mode and reload
        document.getElementById('reorderToggle').checked = false;
        toggleReorderMode();
        loadSchedule();
    }

    function clearReorder() {
        if (!confirm('Clear the custom order and revert to the scheduler\'s original sequence?')) return;

        fetch('/api/schedule/reorder', {method: 'DELETE'})
            .then(r => r.json())
            .then(data => {
                $('#reorderBadge').hide();
                loadSchedule();
            });
    }

    function formatDate(isoString) {
        if (!isoString) return '-';
        const date = new Date(isoString);
        return date.toLocaleDateString('en-US', {
            month: '2-digit',
            day: '2-digit',
            year: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatDateShort(isoString) {
        if (!isoString) return '-';
        const date = new Date(isoString);
        return date.toLocaleDateString('en-US', {
            month: '2-digit',
            day: '2-digit',
            year: '2-digit'
        });
    }

    function refreshSchedule() {
        loadSchedule();
    }
</script>
{% endblock %}

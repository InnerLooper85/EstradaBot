{% extends 'base.html' %}

{% block title %}Schedule - EstradaBot{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-table"></i> Schedule</h2>
    <div>
        <span id="generatedAt" class="text-muted me-3"></span>
        <button class="btn btn-outline-primary me-2" onclick="refreshSchedule()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <button class="btn btn-primary" onclick="generateSchedule()">
            <i class="bi bi-play-circle"></i> Generate New
        </button>
    </div>
</div>

<!-- Stats Summary -->
<div id="statsSection" class="row mb-4" style="display: none;">
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <div class="h4 mb-0" id="statTotal">0</div>
                <small class="text-muted">Total Orders</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <div class="h4 mb-0 text-success" id="statOnTime">0</div>
                <small class="text-muted">On Time</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <div class="h4 mb-0 text-danger" id="statLate">0</div>
                <small class="text-muted">Late</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <div class="h4 mb-0 text-warning" id="statAtRisk">0</div>
                <small class="text-muted">At Risk</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <div class="h4 mb-0" id="statTurnaround">-</div>
                <small class="text-muted">Avg Turnaround</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <div class="h4 mb-0 text-danger" id="statHotList">0</div>
                <small class="text-muted">Hot List</small>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Table -->
<div class="card">
    <div class="card-body">
        <div id="loadingSpinner" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading schedule...</p>
        </div>

        <div id="noSchedule" class="text-center py-5" style="display: none;">
            <i class="bi bi-calendar-x" style="font-size: 4rem; color: #dee2e6;"></i>
            <h4 class="mt-3 text-muted">No Schedule Generated</h4>
            <p class="text-muted">Upload your input files and click "Generate Schedule" to view the schedule.</p>
            <button class="btn btn-primary" onclick="generateSchedule()">
                <i class="bi bi-play-circle"></i> Generate Schedule
            </button>
        </div>

        <div id="scheduleTableContainer" style="display: none;">
            <table id="scheduleTable" class="table table-striped table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th>WO#</th>
                        <th>Serial #</th>
                        <th>Part Number</th>
                        <th>Description</th>
                        <th>Customer</th>
                        <th>Core</th>
                        <th>Rubber</th>
                        <th>Priority</th>
                        <th>BLAST Date</th>
                        <th>Completion</th>
                        <th>Promise Date</th>
                        <th>Turnaround</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="scheduleTableBody">
                </tbody>
                <tfoot>
                    <tr>
                        <th>WO#</th>
                        <th>Serial #</th>
                        <th>Part Number</th>
                        <th>Description</th>
                        <th>Customer</th>
                        <th>Core</th>
                        <th>Rubber</th>
                        <th>Priority</th>
                        <th>BLAST Date</th>
                        <th>Completion</th>
                        <th>Promise Date</th>
                        <th>Turnaround</th>
                        <th>Status</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    #scheduleTable tfoot .column-filter {
        font-size: 0.75rem;
        padding: 0.2rem 0.4rem;
    }
    #scheduleTable tfoot th {
        padding: 4px;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- DataTables Buttons extension -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

<script>
    let dataTable = null;

    $(document).ready(function() {
        loadSchedule();
    });

    function loadSchedule() {
        $('#loadingSpinner').show();
        $('#noSchedule').hide();
        $('#scheduleTableContainer').hide();
        $('#statsSection').hide();

        fetch('/api/schedule')
            .then(response => response.json())
            .then(data => {
                $('#loadingSpinner').hide();

                if (!data.orders || data.orders.length === 0) {
                    $('#noSchedule').show();
                    return;
                }

                // Update stats
                if (data.stats) {
                    $('#statsSection').show();
                    $('#statTotal').text(data.stats.total_orders || 0);
                    $('#statOnTime').text(data.stats.on_time || 0);
                    $('#statLate').text(data.stats.late || 0);
                    $('#statAtRisk').text(data.stats.at_risk || 0);
                    $('#statTurnaround').text(data.stats.avg_turnaround || '-');
                    $('#statHotList').text(data.stats.hot_list_count || 0);
                }

                // Update generated at timestamp
                if (data.generated_at) {
                    const date = new Date(data.generated_at);
                    $('#generatedAt').text('Generated: ' + date.toLocaleString());
                }

                // Build table body
                const tbody = $('#scheduleTableBody');
                tbody.empty();

                data.orders.forEach(order => {
                    const row = buildOrderRow(order);
                    tbody.append(row);
                });

                $('#scheduleTableContainer').show();

                // Initialize or reinitialize DataTable
                if (dataTable) {
                    dataTable.destroy();
                }

                // Dropdown columns: Rubber (6), Priority (7), Status (12)
                const dropdownColumns = {
                    6: ['XE', 'HR', 'XD', 'XR'],
                    7: ['ASAP', 'DATED', 'REWORK', 'NORMAL', 'CAVO'],
                    12: ['On Time', 'Late', 'At Risk']
                };

                // Build filter inputs in tfoot before DataTable init
                $('#scheduleTable tfoot th').each(function(i) {
                    if (i === 3) {
                        // Hidden description column - no filter
                        $(this).html('');
                    } else if (dropdownColumns[i]) {
                        let options = '<option value="">All</option>';
                        dropdownColumns[i].forEach(val => {
                            options += `<option value="${val}">${val}</option>`;
                        });
                        $(this).html(`<select class="form-select form-select-sm column-filter">${options}</select>`);
                    } else {
                        $(this).html('<input type="text" class="form-control form-control-sm column-filter" placeholder="Filter...">');
                    }
                });

                dataTable = $('#scheduleTable').DataTable({
                    pageLength: 25,
                    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                    order: [[8, 'asc']],  // Sort by BLAST date
                    dom: 'Blfrtip',
                    buttons: [
                        {
                            extend: 'excel',
                            text: '<i class="bi bi-file-earmark-excel"></i> Export Excel',
                            className: 'btn btn-success btn-sm',
                            exportOptions: { columns: ':visible' }
                        },
                        {
                            extend: 'print',
                            text: '<i class="bi bi-printer"></i> Print',
                            className: 'btn btn-secondary btn-sm'
                        }
                    ],
                    columnDefs: [
                        { targets: [3], visible: false }  // Hide description by default
                    ]
                });

                // Wire up column filters
                dataTable.columns().every(function() {
                    const column = this;
                    const footer = $(column.footer());
                    const input = footer.find('.column-filter');

                    if (input.is('input')) {
                        input.on('keyup change', function() {
                            if (column.search() !== this.value) {
                                column.search(this.value).draw();
                            }
                        });
                    } else if (input.is('select')) {
                        input.on('change', function() {
                            const val = $.fn.dataTable.util.escapeRegex(this.value);
                            column.search(val ? val : '', false, false).draw();
                        });
                    }
                });
            })
            .catch(error => {
                console.error('Error loading schedule:', error);
                $('#loadingSpinner').hide();
                $('#noSchedule').show();
            });
    }

    function buildOrderRow(order) {
        const blastDate = order.blast_date ? formatDate(order.blast_date) : '-';
        const completionDate = order.completion_date ? formatDate(order.completion_date) : '-';
        const promiseDate = order.promise_date ? formatDateShort(order.promise_date) : '-';

        let priorityBadge = '';
        switch(order.priority) {
            case 'Hot-ASAP':
                priorityBadge = '<span class="badge priority-hot-asap">ASAP</span>';
                break;
            case 'Hot-Dated':
                priorityBadge = '<span class="badge priority-hot-dated">DATED</span>';
                break;
            case 'Rework':
                priorityBadge = '<span class="badge priority-rework">REWORK</span>';
                break;
            case 'CAVO':
                priorityBadge = '<span class="badge bg-info">CAVO</span>';
                break;
            default:
                priorityBadge = '<span class="badge priority-normal">NORMAL</span>';
        }

        let statusBadge = '';
        switch(order.on_time_status) {
            case 'Late':
                statusBadge = '<span class="badge bg-danger">Late</span>';
                break;
            case 'At Risk':
                statusBadge = '<span class="badge bg-warning text-dark">At Risk</span>';
                break;
            default:
                statusBadge = '<span class="badge bg-success">On Time</span>';
        }

        const desc = order.description || '';
        const customer = order.customer || '';

        return `<tr>
            <td><strong>${order.wo_number}</strong></td>
            <td>${order.serial_number || '-'}</td>
            <td>${order.part_number}</td>
            <td>${desc.substring(0, 40)}${desc.length > 40 ? '...' : ''}</td>
            <td>${customer.substring(0, 25)}${customer.length > 25 ? '...' : ''}</td>
            <td>${order.core || '-'}</td>
            <td>${order.rubber_type || '-'}</td>
            <td>${priorityBadge}</td>
            <td data-order="${order.blast_date || ''}">${blastDate}</td>
            <td data-order="${order.completion_date || ''}">${completionDate}</td>
            <td data-order="${order.promise_date || ''}">${promiseDate}</td>
            <td>${order.turnaround_days || '-'}</td>
            <td>${statusBadge}</td>
        </tr>`;
    }

    function formatDate(isoString) {
        if (!isoString) return '-';
        const date = new Date(isoString);
        return date.toLocaleDateString('en-US', {
            month: '2-digit',
            day: '2-digit',
            year: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatDateShort(isoString) {
        if (!isoString) return '-';
        const date = new Date(isoString);
        return date.toLocaleDateString('en-US', {
            month: '2-digit',
            day: '2-digit',
            year: '2-digit'
        });
    }

    function refreshSchedule() {
        loadSchedule();
    }
</script>
{% endblock %}
